<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Android Binder机制 | Phoenix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Android Binder机制概念">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Binder机制">
<meta property="og:url" content="http://yoursite.com/2022/07/17/Android%20Binder%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="Phoenix">
<meta property="og:description" content="Android Binder机制概念">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="z:/workspace/code/Blog/phoenixwxy.github.io/source/_posts/android_pic.assets/binder_01.gif">
<meta property="article:published_time" content="2022-07-17T07:54:04.089Z">
<meta property="article:modified_time" content="2022-07-17T07:54:04.089Z">
<meta property="article:author" content="Phoenix">
<meta property="article:tag" content="learn">
<meta property="article:tag" content="Program">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="z:/workspace/code/Blog/phoenixwxy.github.io/source/_posts/android_pic.assets/binder_01.gif">
  
    <link rel="alternate" href="/phoenixwxy.github.io/atom.xml" title="Phoenix" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/phoenixwxy.github.io/css/style.css">

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/phoenixwxy.github.io/" id="logo">Phoenix</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/phoenixwxy.github.io/">Home</a>
        
          <a class="main-nav-link" href="/phoenixwxy.github.io/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/phoenixwxy.github.io/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Android Binder机制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/phoenixwxy.github.io/2022/07/17/Android%20Binder%E6%9C%BA%E5%88%B6/" class="article-date">
  <time datetime="2022-07-17T07:54:04.089Z" itemprop="datePublished">2022-07-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/phoenixwxy.github.io/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android Binder机制
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android-Binder机制"><a href="#Android-Binder机制" class="headerlink" title="Android Binder机制"></a>Android Binder机制</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><span id="more"></span>
<p>Binder是一种进程通信机制（IPC，Inter-Process Communication）。Google在Android上使用的Binder机制是基于<a target="_blank" rel="noopener" href="http://www.angryredplanet.com/~hackbod/openbinder/docs/html/BinderIPCMechanism.html">OpenBinder: Binder IPC Mechanism</a>来实现的。</p>
<p>在Android系统的Binder机制中，由一系列的系统组件构成：Client、Server、Service Manager和Binder驱动程序。其中Client、Server、Service Manager在用户空间，Binder驱动程序运行在内核空间。所以Binder通信就是Client-Server在Binder驱动和ServiceManager的基础上进行通信。该结构使用了设计模式中的代理模式<a target="_blank" rel="noopener" href="https://www.runoob.com/design-pattern/proxy-pattern.html">代理模式</a></p>
<p><img src="Z:\workspace\code\Blog\phoenixwxy.github.io\source\_posts\android_pic.assets\binder_01.gif" alt=""></p>
<ol>
<li>Client、Server和Service Manager实现在用户空间中，Binder驱动程序实现在内核空间中</li>
<li>Binder驱动程序和Service Manager在Android平台中已经实现，开发者只需要在用户空间实现自己的Client和Server</li>
<li>Binder驱动程序提供设备文件/dev/binder与用户空间交互，Client、Server和Service Manager通过open和ioctl文件操作函数与Binder驱动程序进行通信</li>
<li>Client和Server之间的进程间通信通过Binder驱动程序间接实现</li>
<li>Service Manager是一个守护进程，用来管理Server，并向Client提供查询Server接口的能力</li>
</ol>
<h2 id="ServiceManager"><a href="#ServiceManager" class="headerlink" title="ServiceManager"></a>ServiceManager</h2><p>ServiceManager用来管理Client和Server的通信，且三者属于不同进程；所以三者之间的通信都是Binder通信。所以ServiceManager在充当Binder的守护进程的时候，也在充当Server。</p>
<h2 id="Binder驱动"><a href="#Binder驱动" class="headerlink" title="Binder驱动"></a>Binder驱动</h2><h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BnBinder                        Binder Native</span><br><span class="line">BpBInder                        Binder Proxy</span><br></pre></td></tr></table></figure>
<h1 id="CodeFollow"><a href="#CodeFollow" class="headerlink" title="CodeFollow"></a>CodeFollow</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br></pre></td><td class="code"><pre><span class="line">frameworks/native/cmds/servicemanager/main.<span class="function">cpp</span></span><br><span class="line"><span class="function">    <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="comment">// driver的具体名字</span></span></span><br><span class="line"><span class="function">        <span class="type">const</span> <span class="type">char</span>* driver </span>= argc == <span class="number">2</span> ? argv[<span class="number">1</span>] : <span class="string">&quot;/dev/binder&quot;</span>;</span><br><span class="line">        <span class="comment">// !!!!!----------------!!!!!!!!!!!!!!!!!--------------!!!!!!!!!!!!!!-------------------------!!!!!!!!!!! 相同逻辑</span></span><br><span class="line">        sp&lt;ProcessState&gt; ps = ProcessState::<span class="built_in">initWithDriver</span>(driver);</span><br><span class="line">            <span class="built_in">init</span>(driver, <span class="literal">true</span> <span class="comment">/*requireDefault*/</span>)</span><br><span class="line">                <span class="comment">// 全局对象声明</span></span><br><span class="line">                <span class="type">static</span> sp&lt;ProcessState&gt; gProcess;</span><br><span class="line">                <span class="comment">// 全局构造一个 ProcessState 对象</span></span><br><span class="line">                <span class="comment">// 此时会触发构造函数</span></span><br><span class="line">                std::<span class="built_in">call_once</span>(gProcessOnce, [&amp;]()&#123;gProcess = sp&lt;ProcessState&gt;::<span class="built_in">make</span>(driver);&#125;</span><br><span class="line">                    <span class="built_in">mDriverName</span>(<span class="built_in">String8</span>(driver))</span><br><span class="line">                    <span class="comment">// binder</span></span><br><span class="line">                    <span class="built_in">mDriverFD</span>(<span class="built_in">open_driver</span>(driver))</span><br><span class="line">                        <span class="type">int</span> fd = <span class="built_in">open</span>(driver, O_RDWR | O_CLOEXEC);</span><br><span class="line">                        <span class="comment">// 判断Binder版本!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line">                        <span class="type">status_t</span> result = <span class="built_in">ioctl</span>(fd, BINDER_VERSION, &amp;vers);</span><br><span class="line">                        <span class="comment">// 设置最大线程数,default 15</span></span><br><span class="line">                        result = <span class="built_in">ioctl</span>(fd, BINDER_SET_MAX_THREADS, &amp;maxThreads);</span><br><span class="line">                        <span class="comment">// 垃圾检测功能？？？？？</span></span><br><span class="line">                        result = <span class="built_in">ioctl</span>(fd, BINDER_ENABLE_ONEWAY_SPAM_DETECTION, &amp;enable);</span><br><span class="line">                    <span class="comment">// 申请binder使用的虚拟内存</span></span><br><span class="line">                    mVMStart = <span class="built_in">mmap</span>(<span class="literal">nullptr</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span> gProcess;</span><br><span class="line">        ps-&gt;<span class="built_in">setThreadPoolMaxThreadCount</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 设置出错时的处理逻辑,FATAL_IF_NOT_ONEWAY表示出错直接abort</span></span><br><span class="line">        ps-&gt;<span class="built_in">setCallRestriction</span>(ProcessState::CallRestriction::FATAL_IF_NOT_ONEWAY);</span><br><span class="line">        <span class="comment">// 构造一个 ServiceManager 对象!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line">        <span class="comment">// 这里ServiceManager继承自 BnServicemanager 和 IBinder::DeathRecipient, 后面这个使用在ServiceManager死亡时使用</span></span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        sp&lt;ServiceManager&gt; manager = sp&lt;ServiceManager&gt;::<span class="built_in">make</span>(std::<span class="built_in">make_unique</span>&lt;Access&gt;());</span><br><span class="line">        <span class="comment">// 将构造出来的manager放到manager中的mAccess中</span></span><br><span class="line">        <span class="keyword">if</span> (!manager-&gt;<span class="built_in">addService</span>(<span class="string">&quot;manager&quot;</span>, manager, <span class="literal">false</span> <span class="comment">/*allowIsolated*/</span>, IServiceManager::DUMP_FLAG_PRIORITY_DEFAULT).<span class="built_in">isOk</span>())</span><br><span class="line">            <span class="keyword">auto</span> ctx = mAccess-&gt;<span class="built_in">getCallingContext</span>();</span><br><span class="line">            <span class="comment">// uid鉴权</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">multiuser_get_app_id</span>(ctx.uid) &gt;= AID_APP) &#123;</span><br><span class="line">                <span class="keyword">return</span> Status::<span class="built_in">fromExceptionCode</span>(Status::EX_SECURITY);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//selinux鉴权</span></span><br><span class="line">            <span class="keyword">if</span> (!mAccess-&gt;<span class="built_in">canAdd</span>(ctx, name)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Status::<span class="built_in">fromExceptionCode</span>(Status::EX_SECURITY);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//检查name命名</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">isValidServiceName</span>(name)) &#123;</span><br><span class="line">                <span class="built_in">LOG</span>(ERROR) &lt;&lt; <span class="string">&quot;Invalid service name: &quot;</span> &lt;&lt; name;</span><br><span class="line">                <span class="keyword">return</span> Status::<span class="built_in">fromExceptionCode</span>(Status::EX_ILLEGAL_ARGUMENT);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果vndservicemanager则检查VINTF manifest</span></span><br><span class="line">        <span class="meta">#<span class="keyword">ifndef</span> VENDORSERVICEMANAGER</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">meetsDeclarationRequirements</span>(binder, name)) &#123;</span><br><span class="line">                <span class="comment">// already logged</span></span><br><span class="line">                <span class="keyword">return</span> Status::<span class="built_in">fromExceptionCode</span>(Status::EX_ILLEGAL_ARGUMENT);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span>  <span class="comment">// !VENDORSERVICEMANAGER</span></span></span><br><span class="line">            <span class="comment">//和rpc有关，死亡监听</span></span><br><span class="line">            <span class="comment">// implicitly unlinked when the binder is removed</span></span><br><span class="line">            <span class="keyword">if</span> (binder-&gt;<span class="built_in">remoteBinder</span>() != <span class="literal">nullptr</span> &amp;&amp;</span><br><span class="line">                binder-&gt;<span class="built_in">linkToDeath</span>(sp&lt;ServiceManager&gt;::<span class="built_in">fromExisting</span>(<span class="keyword">this</span>)) != OK) &#123;</span><br><span class="line">                <span class="built_in">LOG</span>(ERROR) &lt;&lt; <span class="string">&quot;Could not linkToDeath when adding &quot;</span> &lt;&lt; name;</span><br><span class="line">                <span class="keyword">return</span> Status::<span class="built_in">fromExceptionCode</span>(Status::EX_ILLEGAL_STATE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//新增一个结构体到map中</span></span><br><span class="line">            <span class="comment">// Overwrite the old service if it exists</span></span><br><span class="line">            mNameToService[name] = Service &#123;</span><br><span class="line">                .binder = binder,</span><br><span class="line">                .allowIsolated = allowIsolated,</span><br><span class="line">                .dumpPriority = dumpPriority,</span><br><span class="line">                .debugPid = ctx.debugPid,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">//架构中提到的waiteForService的跨进程</span></span><br><span class="line">            <span class="keyword">auto</span> it = mNameToRegistrationCallback.<span class="built_in">find</span>(name);</span><br><span class="line">            <span class="keyword">if</span> (it != mNameToRegistrationCallback.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">const</span> sp&lt;IServiceCallback&gt;&amp; cb : it-&gt;second) &#123;</span><br><span class="line">                    mNameToService[name].guaranteeClient = <span class="literal">true</span>;</span><br><span class="line">                    <span class="comment">// permission checked in registerForNotifications</span></span><br><span class="line">                    cb-&gt;<span class="built_in">onRegistration</span>(name, binder);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// self() 返回一个单例,用于创建一个线程(thread)私有的全局变量,用来存储IPCThreadState对象</span></span><br><span class="line">        <span class="comment">// 将manager设置为localBinder</span></span><br><span class="line">        IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">setTheContextObject</span>(manager);</span><br><span class="line">        <span class="comment">// 将声明并构造的ProcessState对象ps</span></span><br><span class="line">        ps-&gt;<span class="built_in">becomeContextManager</span>();</span><br><span class="line">            <span class="comment">// flat_binder_object 用来表示 Binder将有效数据从一个进程传递给另一个进程</span></span><br><span class="line">            <span class="comment">// FLAT_BINDER_FLAG_TXN_SECURITY_CTX 表示</span></span><br><span class="line">            flat_binder_object obj &#123;</span><br><span class="line">                .flags = FLAT_BINDER_FLAG_TXN_SECURITY_CTX,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// ioctl kernel 将当前进程注册为ServiceManager 只要当前的SMgr没有调用close()关闭Binder驱动就不能有别的进程可以成为SMgr</span></span><br><span class="line">            <span class="type">int</span> result = <span class="built_in">ioctl</span>(mDriverFD, BINDER_SET_CONTEXT_MGR_EXT, &amp;obj);</span><br><span class="line">        sp&lt;Looper&gt; looper = Looper::<span class="built_in">prepare</span>(<span class="literal">false</span> <span class="comment">/*allowNonCallbacks*/</span>);</span><br><span class="line">        <span class="comment">// 设置当前looper的callback,</span></span><br><span class="line">        BinderCallback::<span class="built_in">setupTo</span>(looper);</span><br><span class="line">            sp&lt;BinderCallback&gt; cb = sp&lt;BinderCallback&gt;::<span class="built_in">make</span>();</span><br><span class="line">            <span class="comment">// 获取前面打开的binder fd</span></span><br><span class="line">            IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">setupPolling</span>(&amp;binder_fd);</span><br><span class="line">        <span class="comment">// 注册IClient的CallBack,使用定时？5s？？ handleEvent是从fd读取？</span></span><br><span class="line">        ClientCallbackCallback::<span class="built_in">setupTo</span>(looper, manager);</span><br><span class="line">            <span class="comment">//callBack,执行serviceManager的callback</span></span><br><span class="line">            mManager-&gt;<span class="built_in">handleClientCallbacks</span>();</span><br><span class="line"></span><br><span class="line">ServiceManager 远程接口的实现</span><br><span class="line"><span class="comment">// 创建一个单例</span></span><br><span class="line">[[clang::no_destroy]] <span class="type">static</span> sp&lt;IServiceManager&gt; gDefaultServiceManager;</span><br><span class="line">    sp&lt;IServiceManager&gt; <span class="built_in">defaultServiceManager</span>()</span><br><span class="line">        sp&lt;AidlServiceManager&gt; sm = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">// 只会调用一次,下面这句话里面有大文章</span></span><br><span class="line">        <span class="comment">// !!!!!----------------!!!!!!!!!!!!!!!!!--------------!!!!!!!!!!!!!!-------------------------!!!!!!!!!!! 相同逻辑</span></span><br><span class="line">        <span class="comment">// 首先, ProcessState::self()-&gt;getContextObject(nullptr) 等价于 new BpBinder(0)</span></span><br><span class="line">        <span class="comment">// 首先是调用ProcessState::self函数,self函数是ProcessState的静态成员函数,它的作用是返回一个全局唯一的ProcessState实例变量,就是单例模式了,</span></span><br><span class="line">        <span class="comment">// 这个变量名为gProcess。如果gProcess尚未创建,就会执行创建操作,在ProcessState的构造函数中,</span></span><br><span class="line">        <span class="comment">// 会通过open文件操作函数打开设备文件/dev/binder,并且返回来的设备文件描述符保存在成员变量mDriverFD中。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接着调用gProcess-&gt;getContextObject函数来获得一个句柄值为0的Binder引用,即BpBinder了,于是创建Service Manager远程接口的语句可以简化为：</span></span><br><span class="line">        sm = <span class="built_in">interface_cast</span>&lt;AidlServiceManager&gt;(ProcessState::<span class="built_in">self</span>()-&gt;<span class="built_in">getContextObject</span>(<span class="literal">nullptr</span>));</span><br><span class="line">            <span class="built_in">interface_cast</span>&lt;AidlServiceManager&gt;(<span class="keyword">new</span> <span class="built_in">BpBinder</span>(<span class="number">0</span>))</span><br><span class="line">                ProcessState::<span class="built_in">self</span>()-&gt;<span class="built_in">getContextObject</span>(<span class="literal">nullptr</span>)</span><br><span class="line">                    <span class="comment">// 通过访问IBinder 0既获取 BpServiceManager,remote为BpBinder</span></span><br><span class="line">                    sp&lt;IBinder&gt; context = <span class="built_in">getStrongProxyForHandle</span>(<span class="number">0</span>);</span><br><span class="line">                        <span class="comment">// 通过和已经保存的Handle对象的数量对比,第一次进到这个逻辑, N肯定为0,所以创建一个空的 handle_entry e,并添加到数组里面并返回</span></span><br><span class="line">                        handle_entry* e = <span class="built_in">lookupHandleLocked</span>(handle);</span><br><span class="line">                        mHandleToObject</span><br><span class="line">                        <span class="comment">// 表示需要创建一个新的BpBinder,并且传入handle为0,且引用(wp)？？？</span></span><br><span class="line">                        <span class="comment">// 此时表明我们需要一个特殊的Binder用来支持 ServiceManager的contextManager, BpBinder是SMgr的 Proxy,既remoteBinder(远程binder)</span></span><br><span class="line">                        <span class="comment">// 以供Client链接,此处的client指代的是XX Service(MediaService/CameraServer)</span></span><br><span class="line">                        <span class="keyword">if</span> b is null &amp;&amp; e-&gt;<span class="built_in">refs</span>(wp) is include &amp;&amp; handle is <span class="number">0</span></span><br><span class="line">                            <span class="comment">// 理解为用于跨进程时,用于保存各种数据的对象,并且改对象提供很多方法用于存取数据</span></span><br><span class="line">                            Parcel data;</span><br><span class="line"></span><br><span class="line">                            <span class="type">status_t</span> status = ipc-&gt;<span class="built_in">transact</span>(<span class="number">0</span>, IBinder::PING_TRANSACTION, data, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">                                err = <span class="built_in">writeTransactionData</span>(BC_TRANSACTION, flags, handle, code, data, <span class="literal">nullptr</span>);</span><br><span class="line">                                    <span class="comment">// 通过ioctl向binder驱动发送了个啥消息,不明白,从上面注释看起来意思是在Binder驱动(kernel)搞了一个context(上下文) manager</span></span><br><span class="line">                                    err = <span class="built_in">waitForResponse</span>(&amp;fakeReply);</span><br><span class="line">                                        <span class="comment">// 创建了一个 Parcel 将配的参数突突突就通过 talkWithDriver </span></span><br><span class="line">                                        <span class="keyword">if</span> ((err=<span class="built_in">talkWithDriver</span>()) &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">                                            <span class="keyword">if</span> (<span class="built_in">ioctl</span>(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="number">0</span>)</span><br><span class="line">                                        <span class="comment">// 然后mIn(Parcel)怎么就有一个cmd去switch,一顿乱读就返回了</span></span><br><span class="line">                            <span class="comment">// 呕吼！！！创建了BpBinder, handle 是 0 ！！！！！！！！</span></span><br><span class="line">                            sp&lt;BpBinder&gt; b = BpBinder::<span class="built_in">create</span>(handle);</span><br><span class="line">                                <span class="comment">// 一坨逻辑,看起来向记录下了调用者的Uid然后放到了一个List,然后看是不是有太多的代理正在连接？</span></span><br><span class="line">                                <span class="keyword">return</span> sp&lt;BpBinder&gt;::<span class="built_in">make</span>(BinderHandle&#123;handle&#125;, trackedUid);</span><br><span class="line">                                    mHandle == BinderHandle&#123;handle&#125;</span><br><span class="line">                                    <span class="comment">// BpBinder和handle的引用加入到Parcel mOut,</span></span><br><span class="line">                                    IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">incWeakHandle</span>(<span class="keyword">this</span>-&gt;<span class="built_in">binderHandle</span>(), <span class="keyword">this</span>);</span><br><span class="line">                <span class="comment">// 创建了一个BpBinder对象,handle是 0 ,ProcessState和IPCThreadState都有了,也记录相关信息</span></span><br><span class="line">            <span class="comment">// frameworks/native/libs/binder/IServiceManager.cpp</span></span><br><span class="line">            <span class="comment">// interface_cast 这是一个模板函数, 所以这里返回的应该是 AidlServiceManager::asInterface(obj)</span></span><br><span class="line">            <span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt; <span class="keyword">inline</span> sp&lt;INTERFACE&gt; <span class="built_in">interface_cast</span>(<span class="type">const</span> sp&lt;IBinder&gt;&amp; obj)</span><br><span class="line">                <span class="keyword">return</span> INTERFACE::<span class="built_in">asInterface</span>(obj);</span><br><span class="line">            <span class="comment">// 因为这里,所以,调用还是 android::os::IServiceManager 的 asInterface, 但是 android::os::IServiceManager是编译中自动生成的</span></span><br><span class="line">            <span class="keyword">using</span> AidlServiceManager = android::os::IServiceManager;</span><br><span class="line">            <span class="comment">// DECLARE_META_INTERFACE(INTERFACE)  定义在 frameworks/native/include/binder/IInterface.h 用来声明方法</span></span><br><span class="line">            <span class="comment">// 从代码看就是生成了一个 I##INTERFACE的类构造,一些方法,翻译过来就是: android::os::IServiceManager的构造函数等</span></span><br><span class="line">            <span class="comment">// IMPLEMENT_META_INTERFACE(INTERFACE, NAME) 定义在 frameworks/native/include/binder/IInterface.h 用来实现方法？？？？</span></span><br><span class="line">            <span class="comment">// 通过宏生成 asInterface 函数,就是将生成的 INTERFACE 的类,</span></span><br><span class="line">            <span class="comment">//  android::sp&lt;IServiceManager&gt; IServiceManager::asInterface(const android::sp&lt;android::IBinder&gt;&amp; obj)</span></span><br><span class="line">            <span class="comment">//  &#123;</span></span><br><span class="line">            <span class="comment">//      android::sp&lt;IServiceManager&gt; intr;</span></span><br><span class="line">            <span class="comment">//      if (obj != NULL) &#123;                                             </span></span><br><span class="line">            <span class="comment">//          intr = static_cast&lt;IServiceManager *&gt;(  </span></span><br><span class="line">                           <span class="comment">// 这里的 obj指的是 BpBinder,所以调用queryLocalInterface实现在BpBinder, IServiceManager::descriptor)是通过宏定义生成的另外一个方法</span></span><br><span class="line">                           <span class="comment">// const android::String16 IServiceManager::descriptor(&quot;android.os.IServiceManager&quot;);</span></span><br><span class="line">            <span class="comment">//             obj-&gt;queryLocalInterface(IServiceManager::descriptor).get());              </span></span><br><span class="line">            <span class="comment">//          if (intr == NULL) &#123;            </span></span><br><span class="line">                            <span class="comment">// 创建一个 BpServiceManager,将 BpBinder对象传进去了。。。</span></span><br><span class="line">                            <span class="comment">// 由于,BpServiceManager继承自 BnInterface</span></span><br><span class="line">                            <span class="comment">// 所以,BpInterface(const sp&lt;IBinder&gt;&amp; remote); remote就是BpBinder</span></span><br><span class="line">                            <span class="comment">// BpInterface 继承自 BpRefBase,所以 IBinder* const mRemote; mRemote就是 remote就是BpBinder</span></span><br><span class="line">                            <span class="comment">// 所以 inline IBinder* remote() const &#123; return mRemote; &#125;返回的是BpBinder</span></span><br><span class="line">            <span class="comment">//              intr = new BpServiceManager(obj);                         </span></span><br><span class="line">            <span class="comment">//          &#125;                                                          </span></span><br><span class="line">            <span class="comment">//      &#125;                                                               </span></span><br><span class="line">            <span class="comment">//      return intr;                                                   </span></span><br><span class="line">            <span class="comment">//  &#125; </span></span><br><span class="line">        <span class="comment">// 从上面逻辑叙述,我们知道了, sm这个对象实际是根据Binder中handle 0为ServiceManager使用binder定义,</span></span><br><span class="line">        <span class="comment">// 使用hanlde创建一个BpBinder对象后用于远程代理,并最终生成的一个BpServicemanager。</span></span><br><span class="line">        <span class="comment">// 可以将上面 sm = interface_cast&lt;AidlServiceManager&gt;(ProcessState::self()-&gt;getContextObject(nullptr)); 简化为：</span></span><br><span class="line">        <span class="comment">// sm = new BpServiceManager(new BpBinder(0))</span></span><br><span class="line">        <span class="comment">// 使用sm(BpServiceManager)构建一个gDefaultServiceManager,是对ServiceManagerShim的实现。</span></span><br><span class="line">        gDefaultServiceManager = sp&lt;ServiceManagerShim&gt;::<span class="built_in">make</span>(sm);</span><br><span class="line">    <span class="comment">// 此时, ServiceManager就拿到了他的远程接口,本质上是一个BpServiceManager,包含了一个Hanlde为0的Binder应用</span></span><br><span class="line">    <span class="comment">// 对于Server来说,就是调用IServiceManager::addService这个接口来和Binder驱动程序交互了,即调用BpServiceManager::addService。</span></span><br><span class="line">    <span class="comment">// 而BpServiceManager::addService又会调用通过其基类BpRefBase的成员函数remote获得原先创建的BpBinder实例,</span></span><br><span class="line">    <span class="comment">// 接着调用BpBinder::transact成员函数。在BpBinder::transact函数中,又会调用IPCThreadState::transact成员函数,</span></span><br><span class="line">    <span class="comment">// 这里就是最终与Binder驱动程序交互的地方了</span></span><br><span class="line">    <span class="comment">// 对Client来说,就是调用IServiceManager::getService这个接口来和Binder驱动程序交互了。具体过程上述Server使用Service Manager的方法是一样的</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server启动过程</span><br><span class="line"><span class="comment">// 使用的是MediaPlayerService进行举例</span></span><br><span class="line"><span class="keyword">class</span> IBinder : <span class="keyword">public</span> <span class="keyword">virtual</span> RefBase</span><br><span class="line"><span class="keyword">class</span> IInterface : <span class="keyword">public</span> <span class="keyword">virtual</span> RefBase</span><br><span class="line"><span class="keyword">class</span> BBinder : <span class="keyword">public</span> IBinder</span><br><span class="line"><span class="keyword">class</span> IMediaPlayerService: <span class="keyword">public</span> IInterface</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt;</span><br><span class="line"><span class="keyword">class</span> BnInterface : <span class="keyword">public</span> INTERFACE, <span class="keyword">public</span> BBinder</span><br><span class="line"><span class="keyword">class</span> BnMediaPlayerService: <span class="keyword">public</span> BnInterface&lt;IMediaPlayerService&gt;</span><br><span class="line"><span class="keyword">class</span> MediaPlayerService : <span class="keyword">public</span> BnMediaPlayerService</span><br><span class="line"></span><br><span class="line"><span class="comment">// frameworks/av/media/mediaserver/main_mediaserver.cpp</span></span><br><span class="line">    main</span><br><span class="line">        <span class="comment">// 调用ProcessState,是单例,在构造的时候就已经打开了Binder设备并初始化了线程数量以及版本检测,申请了Binder使用的mmap的内存</span></span><br><span class="line">        sp&lt;ProcessState&gt; <span class="built_in">proc</span>(ProcessState::<span class="built_in">self</span>());</span><br><span class="line">        <span class="comment">// sm这个对象实际是根据Binder中handle 0为ServiceManager使用binder定义,</span></span><br><span class="line">        <span class="comment">// 使用hanlde创建一个BpBinder对象后用于远程代理,并最终生成的一个BpServicemanager。</span></span><br><span class="line">        <span class="comment">// 可以将上面 sm = interface_cast&lt;AidlServiceManager&gt;(ProcessState::self()-&gt;getContextObject(nullptr)); 简化为：</span></span><br><span class="line">        <span class="comment">// sm = new BpServiceManager(new BpBinder(0))</span></span><br><span class="line">        <span class="comment">// 对于Server来说,就是调用IServiceManager::addService这个接口来和Binder驱动程序交互了,即调用BpServiceManager::addService。</span></span><br><span class="line">        <span class="comment">// 而BpServiceManager::addService又会调用通过其基类BpRefBase的成员函数remote获得原先创建的BpBinder实例,</span></span><br><span class="line">        <span class="comment">// 接着调用BpBinder::transact成员函数。在BpBinder::transact函数中,又会调用IPCThreadState::transact成员函数,</span></span><br><span class="line">        <span class="comment">// 这里就是最终与Binder驱动程序交互的地方了</span></span><br><span class="line">        sp&lt;IServiceManager&gt; <span class="built_in">sm</span>(<span class="built_in">defaultServiceManager</span>());</span><br><span class="line">        MediaPlayerService::<span class="built_in">instantiate</span>();</span><br><span class="line">            <span class="comment">// 将MediaPlayerService添加到Service Manger中</span></span><br><span class="line">            <span class="built_in">defaultServiceManager</span>()-&gt;<span class="built_in">addService</span>(<span class="built_in">String16</span>(<span class="string">&quot;media.player&quot;</span>), <span class="keyword">new</span> <span class="built_in">MediaPlayerService</span>());</span><br><span class="line">                ServiceManagerShim-&gt;<span class="built_in">addService</span>()</span><br><span class="line">                    IServiceManager-&gt;<span class="built_in">addService</span>()</span><br><span class="line">                        BpServiceManager-&gt;<span class="built_in">addService</span>()</span><br><span class="line">                            <span class="comment">// 通过AIDL IServiceManager.aidl 在out/soong下面会有 IServiceManager.cpp</span></span><br><span class="line">                            <span class="comment">// 这部分是通过 libbinder.so + AIDL + Soong生成</span></span><br><span class="line">                            <span class="comment">// 下面这部分自动生成的逻辑，Parcel用来序列化进程间通信数据</span></span><br><span class="line">                            ::android::Parcel _aidl_data;                                                                                 </span><br><span class="line">                            _aidl_data.<span class="built_in">markForBinder</span>(<span class="built_in">remoteStrong</span>());                                                                     </span><br><span class="line">                            ::android::Parcel _aidl_reply;                                                                                </span><br><span class="line">                            ::android::<span class="type">status_t</span> _aidl_ret_status = ::android::OK;                                                         </span><br><span class="line">                            ::android::binder::Status _aidl_status;                    </span><br><span class="line">                            <span class="comment">// getInterfaceDescriptor 是从 IMPLEMENT_META_INTERFACE(INTERFACE, NAME)宏里面生成,保存的是&quot;android.os.IServiceManager&quot;                             </span></span><br><span class="line">                            _aidl_ret_status = _aidl_data.<span class="built_in">writeInterfaceToken</span>(<span class="built_in">getInterfaceDescriptor</span>());                                                                                                </span><br><span class="line">                            _aidl_ret_status = _aidl_data.<span class="built_in">writeUtf8AsUtf16</span>(name);     </span><br><span class="line">                            <span class="comment">// service此时指的是MediaService                                                    </span></span><br><span class="line">                            _aidl_ret_status = _aidl_data.<span class="built_in">writeStrongBinder</span>(service);                                                     </span><br><span class="line">                            _aidl_ret_status = _aidl_data.<span class="built_in">writeBool</span>(allowIsolated);                                                       </span><br><span class="line">                            _aidl_ret_status = _aidl_data.<span class="built_in">writeInt32</span>(dumpPriority);</span><br><span class="line">                            <span class="comment">// 这里的调用逻辑是: 因为 BpServiceManager继承自 BpInterface 和 IServiceManager,</span></span><br><span class="line">                            <span class="comment">// BpInterface 继承自 BpRefBase,而 BpRefBase提供remote()用来获取ServiceManager的BpBider,                                           </span></span><br><span class="line">                            _aidl_ret_status = <span class="built_in">remote</span>()-&gt;<span class="built_in">transact</span>(BnServiceManager::TRANSACTION_addService, _aidl_data, &amp;_aidl_reply, <span class="number">0</span>);</span><br><span class="line">                                BpBinder-&gt;<span class="built_in">transact</span>(BnServiceManager::TRANSACTION_addService, _aidl_data, &amp;_aidl_reply, <span class="number">0</span>);</span><br><span class="line">                                    status = IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">transact</span>(<span class="built_in">binderHandle</span>(), code, data, reply, flags);</span><br><span class="line">                                        IPCThreadState-&gt;<span class="type">int32_t</span> handle,<span class="type">uint32_t</span> code, <span class="type">const</span> Parcel&amp; data,Parcel* reply, <span class="type">uint32_t</span> flags)</span><br><span class="line">                                            <span class="comment">// 里面写的东西其实就是上面写的service,name之类的</span></span><br><span class="line">                                            err = <span class="built_in">writeTransactionData</span>(BC_TRANSACTION, flags, handle, code, data, <span class="literal">nullptr</span>);</span><br><span class="line">                                            <span class="keyword">if</span> (flags &amp; TF_ONE_WAY == <span class="number">0</span>)</span><br><span class="line">                                                <span class="comment">// 这个函数会有很多Binder操作, 具体的后面看Binder驱动再说</span></span><br><span class="line">                                                err = <span class="built_in">waitForResponse</span>(reply);</span><br><span class="line">                                                    <span class="keyword">if</span> ((err=<span class="built_in">talkWithDriver</span>()) &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">                                                        <span class="keyword">if</span> (<span class="built_in">ioctl</span>(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="number">0</span>)</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">UNLIKELY</span>(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::<span class="built_in">getDefaultImpl</span>())) &#123;      </span><br><span class="line">                            <span class="keyword">return</span> IServiceManager::<span class="built_in">getDefaultImpl</span>()-&gt;<span class="built_in">addService</span>(name, service, allowIsolated, dumpPriority);          </span><br><span class="line">                            &#125;                                                                                                             </span><br><span class="line">                            _aidl_ret_status = _aidl_status.<span class="built_in">readFromParcel</span>(_aidl_reply);                                                  </span><br><span class="line">                            _aidl_status.<span class="built_in">setFromStatusT</span>(_aidl_ret_status);                                                                </span><br><span class="line">                            <span class="keyword">return</span> _aidl_status;  </span><br><span class="line"><span class="comment">// 注意这里同时将服务端会有相应的处理逻辑,  </span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">BinderCallback</span> : <span class="keyword">public</span> LooperCallback &#123;</span><br><span class="line">        <span class="function"><span class="type">int</span> <span class="title">handleEvent</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            <span class="title">IPCThreadState::self</span><span class="params">()</span>-&gt;<span class="title">handlePolledCommands</span><span class="params">()</span></span>; </span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    result = <span class="built_in">getAndExecuteCommand</span>();</span><br><span class="line">                        result = <span class="built_in">talkWithDriver</span>();</span><br><span class="line">                            result = <span class="built_in">executeCommand</span>(cmd);</span><br><span class="line">                                ...</span><br><span class="line">                                error = <span class="built_in">reinterpret_cast</span>&lt;BBinder*&gt;(tr.cookie)-&gt;<span class="built_in">transact</span>(tr.code, buffer, &amp;reply, tr.flags);</span><br><span class="line">                                    <span class="comment">// 这个也是自动生成的文件</span></span><br><span class="line">                                    BnServiceManager-&gt;<span class="built_in">onTransact</span>();</span><br><span class="line">                                        <span class="keyword">case</span> BnServiceManager::TRANSACTION_addService:</span><br><span class="line">                                            ::android::binder::Status _aidl_status(<span class="built_in">addService</span>(in_name, in_service, in_allowIsolated, in_dumpPriority));</span><br><span class="line">                                                ServiceManager-&gt;<span class="built_in">addService</span>();</span><br><span class="line">                                ...</span><br><span class="line">                &#125; <span class="keyword">while</span> (mIn.<span class="built_in">dataPosition</span>() &lt; mIn.<span class="built_in">dataSize</span>());</span><br><span class="line"></span><br><span class="line">                <span class="built_in">processPendingDerefs</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ::android::hardware::<span class="built_in">configureRpcThreadpool</span>(<span class="number">16</span>, <span class="literal">false</span>);</span><br><span class="line">        ProcessState::<span class="built_in">self</span>()-&gt;<span class="built_in">startThreadPool</span>();</span><br><span class="line">            ProcessState-&gt;<span class="built_in">spawnPooledThread</span>(<span class="literal">true</span>);</span><br><span class="line">                sp&lt;Thread&gt; t = sp&lt;PoolThread&gt;::<span class="built_in">make</span>(isMain);</span><br><span class="line">                t-&gt;<span class="function">run</span></span><br><span class="line"><span class="function">                    <span class="title">threadLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">                        <span class="comment">// 和main函数一样都是这个函数, mIsMain是 true</span></span></span><br><span class="line"><span class="function">                        <span class="title">IPCThreadState::self</span><span class="params">()</span>-&gt;<span class="title">joinThreadPool</span><span class="params">(mIsMain)</span></span>;</span><br><span class="line">                            mOut.<span class="built_in">writeInt32</span>(isMain ? BC_ENTER_LOOPER : BC_REGISTER_LOOPER);</span><br><span class="line">                            <span class="keyword">do</span> &#123;</span><br><span class="line">                                <span class="built_in">processPendingDerefs</span>();</span><br><span class="line">                                result = <span class="built_in">getAndExecuteCommand</span>();</span><br><span class="line">                                    result = <span class="built_in">talkWithDriver</span>();</span><br><span class="line">                                        <span class="comment">// 函数里面会有真正的BBinder处理Client的请求</span></span><br><span class="line">                                        result = <span class="built_in">executeCommand</span>(cmd);</span><br><span class="line">                                            ...</span><br><span class="line">                                            error = <span class="built_in">reinterpret_cast</span>&lt;BBinder*&gt;(tr.cookie)-&gt;<span class="built_in">transact</span>(tr.code, buffer, &amp;reply, tr.flags);</span><br><span class="line">                                                BnMediaPlayerService-&gt;<span class="built_in">onTransact</span>()</span><br><span class="line">                                                <span class="comment">// 具体业务流程</span></span><br><span class="line">                                            ...</span><br><span class="line">                            &#125; <span class="keyword">while</span> (result != -ECONNREFUSED &amp;&amp; result != -EBADF);</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">talkWithDriver</span>(<span class="literal">false</span>);</span><br><span class="line">        IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">joinThreadPool</span>();</span><br><span class="line">        ::android::hardware::<span class="built_in">joinRpcThreadpool</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Client和Server通信</span><br><span class="line">使用MediaPlayer和MediaService进行分析</span><br><span class="line">    IMediaDeathNotifier::<span class="built_in">getMediaPlayerService</span>()</span><br><span class="line">        sp&lt;IServiceManager&gt; sm = <span class="built_in">defaultServiceManager</span>();</span><br><span class="line">        sp&lt;IBinder&gt; binder;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            binder = sm-&gt;<span class="built_in">getService</span>(<span class="built_in">String16</span>(<span class="string">&quot;media.player&quot;</span>));</span><br><span class="line">                ServiceManagerShim-&gt;<span class="built_in">getService</span>(()</span><br><span class="line">                    <span class="keyword">while</span> (<span class="built_in">uptimeMillis</span>() - startTime &lt; timeout) &#123;</span><br><span class="line">                        sp&lt;IBinder&gt; svc = <span class="built_in">checkService</span>(name);</span><br><span class="line">                            sp&lt;IBinder&gt; ret;</span><br><span class="line">                            <span class="keyword">if</span> (!mTheRealServiceManager-&gt;<span class="built_in">checkService</span>(<span class="built_in">String8</span>(name).<span class="built_in">c_str</span>(), &amp;ret).<span class="built_in">isOk</span>())</span><br><span class="line">                                BpServiceManager-&gt;<span class="built_in">checkService</span>()</span><br><span class="line">                                    _aidl_ret_status = <span class="built_in">remote</span>()-&gt;<span class="built_in">transact</span>(BnServiceManager::TRANSACTION_checkService, _aidl_data, &amp;_aidl_reply, <span class="number">0</span>);</span><br><span class="line">                                    BpBinder-&gt;<span class="built_in">transact</span>(BnServiceManager::TRANSACTION_checkService, _aidl_data, &amp;_aidl_reply, <span class="number">0</span>);</span><br><span class="line">                                    status = IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">transact</span>(<span class="built_in">binderHandle</span>(), code, data, reply, flags);</span><br><span class="line">                                        IPCThreadState-&gt;<span class="type">int32_t</span> handle,<span class="type">uint32_t</span> code, <span class="type">const</span> Parcel&amp; data,Parcel* reply, <span class="type">uint32_t</span> flags)</span><br><span class="line">                                            <span class="comment">// 里面写的东西其实就是上面写的service,name之类的</span></span><br><span class="line">                                            err = <span class="built_in">writeTransactionData</span>(BC_TRANSACTION, flags, handle, code, data, <span class="literal">nullptr</span>);</span><br><span class="line">                                            <span class="keyword">if</span> (flags &amp; TF_ONE_WAY == <span class="number">0</span>)</span><br><span class="line">                                                <span class="comment">// 这个函数会有很多Binder操作, 具体的后面看Binder驱动再说</span></span><br><span class="line">                                                err = <span class="built_in">waitForResponse</span>(reply);</span><br><span class="line">                                                    <span class="keyword">if</span> ((err=<span class="built_in">talkWithDriver</span>()) &lt; NO_ERROR) <span class="keyword">break</span>;</span><br><span class="line">                                                        <span class="keyword">if</span> (<span class="built_in">ioctl</span>(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="number">0</span>)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (binder != <span class="number">0</span>) &#123;                </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">ALOGW</span>(<span class="string">&quot;Media player service not published, waiting...&quot;</span>);</span><br><span class="line">            <span class="built_in">usleep</span>(<span class="number">500000</span>); <span class="comment">// 0.5 s</span></span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Java层如果使用Binder, 并使用ServiceManager来管理Server和Client</span><br><span class="line">frameworks/base/core/java/android/os/ServiceManager.java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ServiceManager</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">static</span> IServiceManager sServiceManager;</span><br><span class="line">        <span class="function">IServiceManager <span class="title">getIServiceManager</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            sServiceManager </span>= ServiceManagerNative.<span class="built_in">asInterface</span>(Binder.<span class="built_in">allowBlocking</span>(BinderInternal.<span class="built_in">getContextObject</span>()));</span><br><span class="line">                Binder.<span class="built_in">allowBlocking</span>(BinderInternal.<span class="built_in">getContextObject</span>())</span><br><span class="line">                    BinderInternal.<span class="built_in">getContextObject</span>()</span><br><span class="line">                        <span class="comment">// native 可以看出来这个是一个JNI的方法</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> native IBinder <span class="title">getContextObject</span><span class="params">()</span></span>;</span><br><span class="line">                            <span class="comment">// frameworks/base/core/jni/android_util_Binder.cpp</span></span><br><span class="line">                            &#123; <span class="string">&quot;getContextObject&quot;</span>, <span class="string">&quot;()Landroid/os/IBinder;&quot;</span>, (<span class="type">void</span>*)android_os_BinderInternal_getContextObject &#125;</span><br><span class="line">                                <span class="built_in">android_os_BinderInternal_getContextObject</span>()</span><br><span class="line">                                    <span class="comment">// 获取的就是全局的ServiceManager,</span></span><br><span class="line">                                    <span class="comment">// 实际就是一个 BpBinder</span></span><br><span class="line">                                    sp&lt;IBinder&gt; b = ProcessState::<span class="built_in">self</span>()-&gt;<span class="built_in">getContextObject</span>(<span class="literal">NULL</span>);</span><br><span class="line">                                        <span class="comment">// static struct bindernative_offsets_t</span></span><br><span class="line">                                        <span class="comment">// &#123;</span></span><br><span class="line">                                        <span class="comment">//     // Class state.</span></span><br><span class="line">                                        <span class="comment">//     jclass mClass;</span></span><br><span class="line">                                        <span class="comment">//     jmethodID mExecTransact;</span></span><br><span class="line">                                        <span class="comment">//     jmethodID mGetInterfaceDescriptor;</span></span><br><span class="line"></span><br><span class="line">                                        <span class="comment">//     // Object state.</span></span><br><span class="line">                                        <span class="comment">//     jfieldID mObject;</span></span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// &#125; gBinderOffsets;</span></span><br><span class="line">                                        <span class="comment">// gBinderOffsets用来记录 Binder信息的，在int_register_android_os_Binder初始化</span></span><br><span class="line">                                        <span class="comment">// static struct binderproxy_offsets_t</span></span><br><span class="line">                                        <span class="comment">// &#123;</span></span><br><span class="line">                                            Class state.</span><br><span class="line">                                            <span class="comment">// jclass mClass;</span></span><br><span class="line">                                            <span class="comment">// jmethodID mGetInstance;</span></span><br><span class="line">                                            <span class="comment">// jmethodID mSendDeathNotice;</span></span><br><span class="line">                                                <span class="comment">// Object state.</span></span><br><span class="line">                                            <span class="comment">// jfieldID mNativeData;  // Field holds native pointer to BinderProxyNativeData.</span></span><br><span class="line">                                        <span class="comment">// &#125; gBinderProxyOffsets;</span></span><br><span class="line">                                        <span class="comment">// gBinderProxyOffsets用来记录 BinderProxy 在int_register_android_os_BinderProxy</span></span><br><span class="line">                                    <span class="keyword">return</span> <span class="built_in">javaObjectForIBinder</span>(env, b)</span><br><span class="line">                                        <span class="keyword">if</span> (val-&gt;<span class="built_in">checkSubclass</span>(&amp;gBinderOffsets)) &#123; <span class="comment">// false</span></span><br><span class="line">                                            jobject object = <span class="built_in">static_cast</span>&lt;JavaBBinder*&gt;(val.<span class="built_in">get</span>())-&gt;<span class="built_in">object</span>();</span><br><span class="line">                                            <span class="keyword">return</span>  object</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        <span class="comment">// 用来保存传进来的 BpBinder对象和 DeathRecipientList</span></span><br><span class="line">                                        BinderProxyNativeData* nativeData = <span class="keyword">new</span> <span class="built_in">BinderProxyNativeData</span>();</span><br><span class="line">                <span class="comment">// 相当于 sServiceManager = ServiceManagerNative.asInterface(new BinderProxy());</span></span><br><span class="line">                <span class="comment">// 相当于 sServiceManager = new ServiceManagerProxy(new BinderProxy());</span></span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="type">static</span> IServiceManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span></span></span><br><span class="line"><span class="function">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">ServiceManagerProxy</span><span class="params">(obj)</span></span>;</span><br><span class="line">                        <span class="keyword">class</span> <span class="title class_">ServiceManagerProxy</span> implements IServiceManager</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/07/17/Android%20Binder%E6%9C%BA%E5%88%B6/" data-id="cl5p1ft600003tks6612mao1t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/phoenixwxy.github.io/tags/Program/" rel="tag">Program</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/phoenixwxy.github.io/tags/learn/" rel="tag">learn</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/phoenixwxy.github.io/2022/07/17/Android_AshMem/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Android 共享内存机制
        
      </div>
    </a>
  
  
    <a href="/phoenixwxy.github.io/2022/07/17/Android_MessageQueue/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">MessageQueue</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/phoenixwxy.github.io/categories/Program/">Program</a></li><li class="category-list-item"><a class="category-list-link" href="/phoenixwxy.github.io/categories/program/">program</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/phoenixwxy.github.io/categories/program/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/phoenixwxy.github.io/categories/program/CMake/">CMake</a></li><li class="category-list-item"><a class="category-list-link" href="/phoenixwxy.github.io/categories/program/doc/">doc</a></li><li class="category-list-item"><a class="category-list-link" href="/phoenixwxy.github.io/categories/program/git/">git</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/phoenixwxy.github.io/categories/%E6%9F%A5%E8%AF%A2/">查询</a></li><li class="category-list-item"><a class="category-list-link" href="/phoenixwxy.github.io/categories/%E7%BC%96%E7%A8%8B/">编程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/CMake/" rel="tag">CMake</a></li><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/Effective/" rel="tag">Effective</a></li><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/Program/" rel="tag">Program</a></li><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/backup/" rel="tag">backup</a></li><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/c/" rel="tag">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/learn/" rel="tag">learn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/phoenixwxy.github.io/tags/shell/" rel="tag">shell</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/phoenixwxy.github.io/tags/Android/" style="font-size: 13.33px;">Android</a> <a href="/phoenixwxy.github.io/tags/C/" style="font-size: 13.33px;">C</a> <a href="/phoenixwxy.github.io/tags/CMake/" style="font-size: 10px;">CMake</a> <a href="/phoenixwxy.github.io/tags/Effective/" style="font-size: 10px;">Effective</a> <a href="/phoenixwxy.github.io/tags/Program/" style="font-size: 20px;">Program</a> <a href="/phoenixwxy.github.io/tags/backup/" style="font-size: 13.33px;">backup</a> <a href="/phoenixwxy.github.io/tags/c/" style="font-size: 10px;">c</a> <a href="/phoenixwxy.github.io/tags/c/" style="font-size: 16.67px;">c++</a> <a href="/phoenixwxy.github.io/tags/git/" style="font-size: 10px;">git</a> <a href="/phoenixwxy.github.io/tags/learn/" style="font-size: 20px;">learn</a> <a href="/phoenixwxy.github.io/tags/shell/" style="font-size: 10px;">shell</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/phoenixwxy.github.io/archives/2022/07/">July 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/phoenixwxy.github.io/2022/07/17/regex/">Regex 正则表达式</a>
          </li>
        
          <li>
            <a href="/phoenixwxy.github.io/2022/07/17/%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/">内存对齐</a>
          </li>
        
          <li>
            <a href="/phoenixwxy.github.io/2022/07/17/%E8%BE%93%E5%87%BA%E5%87%BD%E6%95%B0%E6%AF%94%E8%BE%83/">输出函数比较</a>
          </li>
        
          <li>
            <a href="/phoenixwxy.github.io/2022/07/17/git_submodule/">Git submodule</a>
          </li>
        
          <li>
            <a href="/phoenixwxy.github.io/2022/07/17/getopt/">getopt</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Phoenix<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/phoenixwxy.github.io/" class="mobile-nav-link">Home</a>
  
    <a href="/phoenixwxy.github.io/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/phoenixwxy.github.io/fancybox/jquery.fancybox.css">

  
<script src="/phoenixwxy.github.io/fancybox/jquery.fancybox.pack.js"></script>




<script src="/phoenixwxy.github.io/js/script.js"></script>




  </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>